    <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PasuGame Fixed Version</title>
<style>
  /* CSS styles remain the same as before */
  /* ... (keep all the CSS styles you had) ... */
</style>
</head>
<body>

<div id="game">
  <div id="ground"></div>
  <div id="chibiCat" title="Your cute cat character"></div>

  <div id="coinBar" title="Fish Coins">
    <img src="coin.png" alt="Coin Icon" />
    <span id="coinCount">0</span>
  </div>

  <div id="score" title="Score">Score: 0</div>

  <div id="dino"></div>

  <div id="lobby">
    <button id="playBtn" title="Start Game">Play</button>
    <div id="topMenu">
      <button class="hexBtn" id="btnCharacter" title="Characters">
        <img src="character.png" alt="Character Icon" />
        Characters
      </button>
      <button class="hexBtn" id="btnGuide" title="Guide">
        <img src="guide.png" alt="Guide Icon" />
        Guide
      </button>
      <button class="hexBtn" id="btnOption" title="Options">
        <img src="option.png" alt="Option Icon" />
        Options
      </button>
    </div>
  </div>

<!-- Character Modal -->
<div id="characterModal" class="modal-bg" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-panel" role="document" aria-labelledby="characterTitle" tabindex="0">
    <span class="closeBtn" id="closeCharacter" role="button" aria-label="Close Character Modal">×</span>
    <h2 id="characterTitle">Characters</h2>
    <div id="ownedCharacters"></div>
  </div>
</div>

<!-- Guide Modal -->
<div id="guideModal" class="modal-bg" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-panel" role="document" aria-labelledby="guideTitle" tabindex="0">
    <span class="closeBtn" id="closeGuide" role="button" aria-label="Close Guide Modal">×</span>
    <h2 id="guideTitle">Game Guide</h2>
    <p>Welcome to PasuGame! Avoid obstacles and collect boxes for coins.</p>
    <img src="guide1.png" alt="Guide Image 1" style="width:100%; border-radius: 12px; margin-bottom:12px;" />
    <p>Use jump and slide buttons or keyboard keys W/S or arrow keys.</p>
    <img src="guide2.png" alt="Guide Image 2" style="width:100%; border-radius: 12px; margin-bottom:12px;" />
    <p>Buy characters with coins in the Character menu.</p>
  </div>
</div>

<!-- Option Modal -->
<div id="optionModal" class="modal-bg" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-panel" role="document" aria-labelledby="optionTitle" tabindex="0">
    <span class="closeBtn" id="closeOption" role="button" aria-label="Close Options">×</span>
    <h2 id="optionTitle">Options</h2>
    <label><input type="checkbox" id="toggleBGM" /> Background Music</label><br/>
    <label><input type="checkbox" id="toggleSFX" /> Sound Effects</label>
  </div>
</div>

<!-- Game Over Modal -->
<div id="gameOver" style="display:none;flex-direction:column;justify-content:center;align-items:center;position:fixed;inset:0;background:rgba(0,0,0,0.75);color:white;font-size:32px;font-weight:700;z-index:500;">
  <div>Game Over</div>
  <div id="finalScore" style="margin-bottom: 20px;">Score: 0</div>
  <button id="restartBtn" class="restartBtn">Restart</button>
  <button id="backLobbyBtn" class="lobbyBtn">Back to Lobby</button>
</div>

<!-- Jump and Slide Buttons -->
<button id="jumpBtn" title="Jump" aria-label="Jump" style="display:none; position: fixed; bottom: 20px; right: 110px; width: 90px; height: 90px; border-radius: 50%; background-image: url('jump.png'); background-size: contain; background-position: center; background-repeat: no-repeat; border: none; cursor: pointer; z-index: 220;"></button>
<button id="slideBtn" title="Slide" aria-label="Slide" style="display:none; position: fixed; bottom: 20px; right: 20px; width: 90px; height: 90px; border-radius: 50%; background-image: url('slide.png'); background-size: contain; background-position: center; background-repeat: no-repeat; border: none; cursor: pointer; z-index: 220;"></button>

</div> <!-- end #game -->

<script>
(() => {
  // DOM elements
  const lobby = document.getElementById('lobby');
  const playBtn = document.getElementById('playBtn');
  const characterModal = document.getElementById('characterModal');
  const guideModal = document.getElementById('guideModal');
  const optionModal = document.getElementById('optionModal');
  const closeCharacter = document.getElementById('closeCharacter');
  const closeGuide = document.getElementById('closeGuide');
  const closeOption = document.getElementById('closeOption');
  const btnCharacter = document.getElementById('btnCharacter');
  const btnGuide = document.getElementById('btnGuide');
  const btnOption = document.getElementById('btnOption');
  const coinCountEl = document.getElementById('coinCount');
  const dino = document.getElementById('dino');
  const jumpBtn = document.getElementById('jumpBtn');
  const slideBtn = document.getElementById('slideBtn');
  const scoreEl = document.getElementById('score');
  const gameOverEl = document.getElementById('gameOver');
  const finalScoreEl = document.getElementById('finalScore');
  const restartBtn = document.getElementById('restartBtn');
  const backLobbyBtn = document.getElementById('backLobbyBtn');
  const ownedCharactersEl = document.getElementById('ownedCharacters');
  const toggleBGM = document.getElementById('toggleBGM');
  const toggleSFX = document.getElementById('toggleSFX');

  // Game variables
  let coins = Number(localStorage.getItem('pasu_coins')) || 0;
  let ownedCharacters = JSON.parse(localStorage.getItem('pasu_ownedChars')) || ['myDino'];
  let selectedCharacter = localStorage.getItem('pasu_selectedChar') || 'myDino';

  let isPlaying = false;
  let score = 0;
  let isJumping = false;
  let isSliding = false;
  let velocity = 0;
  const gravity = 0.5;
  const jumpForce = 15;
  let dinoY = 12; // vh bottom position
  const groundLevel = 12;
  const gameSpeed = 4;
  let obstacles = [];
  let boxes = [];
  let animationFrameId = null;

  // Initialize the game
  function initGame() {
    // Initialize UI
    coinCountEl.textContent = coins;
    scoreEl.style.display = 'none';
    jumpBtn.style.display = 'none';
    slideBtn.style.display = 'none';
    
    // Load settings
    if (localStorage.getItem('pasu_bgm') === null) {
      localStorage.setItem('pasu_bgm', 'true');
    }
    if (localStorage.getItem('pasu_sfx') === null) {
      localStorage.setItem('pasu_sfx', 'true');
    }
    
    bgmEnabled = localStorage.getItem('pasu_bgm') !== 'false';
    sfxEnabled = localStorage.getItem('pasu_sfx') !== 'false';
    
    toggleBGM.checked = bgmEnabled;
    toggleSFX.checked = sfxEnabled;
    
    updateCharacterUI();
    updateSelectedCharacter();
    
    // Set up event listeners
    setupEventListeners();
  }

  // Set up all event listeners
  function setupEventListeners() {
    // Button events
    playBtn.addEventListener('click', startGame);
    restartBtn.addEventListener('click', restartGame);
    backLobbyBtn.addEventListener('click', backToLobby);
    
    // Modal controls
    btnCharacter.addEventListener('click', () => openModal(characterModal));
    btnGuide.addEventListener('click', () => openModal(guideModal));
    btnOption.addEventListener('click', () => openModal(optionModal));
    
    closeCharacter.addEventListener('click', () => closeModal(characterModal));
    closeGuide.addEventListener('click', () => closeModal(guideModal));
    closeOption.addEventListener('click', () => closeModal(optionModal));
    
    // Option toggles
    toggleBGM.addEventListener('change', toggleBGMSound);
    toggleSFX.addEventListener('change', toggleSFXSound);
    
    // Game controls
    jumpBtn.addEventListener('click', jump);
    slideBtn.addEventListener('click', slide);
    
    // Keyboard controls
    window.addEventListener('keydown', handleKeyDown);
    
    // Handle visibility change to pause audio when tab is inactive
    document.addEventListener('visibilitychange', handleVisibilityChange);
  }

  // Game functions
  function startGame() {
    if (isPlaying) return;
    
    // Reset game state
    isPlaying = true;
    score = 0;
    obstacles = [];
    boxes = [];
    dinoY = groundLevel;
    velocity = 0;
    isJumping = false;
    isSliding = false;
    
    // Update UI
    lobby.style.display = 'none';
    scoreEl.style.display = 'block';
    scoreEl.textContent = 'Score: 0';
    gameOverEl.style.display = 'none';
    dino.classList.remove('slide');
    
    // Show mobile controls if needed
    if (/Mobi|Android/i.test(navigator.userAgent)) {
      jumpBtn.style.display = 'block';
      slideBtn.style.display = 'block';
    }
    
    // Clear existing obstacles and boxes
    document.querySelectorAll('.obstacle, .box').forEach(el => el.remove());
    
    // Play background music
    if (bgmEnabled) {
      bgmAudio.currentTime = 0;
      bgmAudio.play().catch(e => console.log('Audio play error:', e));
    }
    
    // Start game loop
    frameCount = 0;
    animationFrameId = requestAnimationFrame(gameLoop);
  }

  function endGame() {
    isPlaying = false;
    finalScoreEl.textContent = `Score: ${score}`;
    gameOverEl.style.display = 'flex';
    jumpBtn.style.display = 'none';
    slideBtn.style.display = 'none';
    
    cancelAnimationFrame(animationFrameId);
  }

  function restartGame() {
    gameOverEl.style.display = 'none';
    startGame();
  }

  function backToLobby() {
    gameOverEl.style.display = 'none';
    lobby.style.display = 'flex';
    scoreEl.style.display = 'none';
    
    if (bgmEnabled) {
      bgmAudio.currentTime = 0;
      bgmAudio.play().catch(e => console.log('Audio play error:', e));
    }
  }

  // Player controls
  function jump() {
    if (!isPlaying) return;
    if (!isJumping && !isSliding) {
      isJumping = true;
      velocity = jumpForce;
      if (sfxEnabled) {
        sfxJump.currentTime = 0;
        sfxJump.play().catch(e => console.log('SFX play error:', e));
      }
    }
  }

  function slide() {
    if (!isPlaying) return;
    if (!isSliding && !isJumping) {
      isSliding = true;
      dino.classList.add('slide');
      if (sfxEnabled) {
        sfxSlide.currentTime = 0;
        sfxSlide.play().catch(e => console.log('SFX play error:', e));
      }
      setTimeout(() => {
        isSliding = false;
        dino.classList.remove('slide');
      }, 800);
    }
  }

  // Game loop
  let frameCount = 0;
  function gameLoop() {
    if (!isPlaying) return;

    frameCount++;
    score += 1;
    scoreEl.textContent = `Score: ${score}`;

    // Handle jumping physics
    if (isJumping) {
      dinoY -= velocity;
      velocity -= gravity;
      if (dinoY >= groundLevel) {
        dinoY = groundLevel;
        isJumping = false;
        velocity = 0;
      }
    }
    dino.style.bottom = `${dinoY}vh`;

    // Spawn obstacles and boxes randomly
    if (Math.random() < 0.008) {
      spawnObstacle();
    }
    if (Math.random() < 0.005) {
      spawnBox();
    }

    // Move obstacles
    obstacles.forEach((ob, i) => {
      ob.x -= gameSpeed;
      if (ob.x < -10) {
        ob.element.remove();
        obstacles.splice(i, 1);
      } else {
        ob.element.style.left = `${ob.x}vw`;
      }
    });

    // Move boxes
    boxes.forEach((box, i) => {
      box.x -= gameSpeed;
      if (box.x < -10) {
        box.element.remove();
        boxes.splice(i, 1);
      } else {
        box.element.style.left = `${box.x}vw`;
      }
    });

    // Check for collisions
    checkCollisions();

    // Continue game loop
    animationFrameId = requestAnimationFrame(gameLoop);
  }

  function spawnObstacle() {
    const obEl = document.createElement('div');
    obEl.className = 'obstacle';
    obEl.style.left = '110vw';
    document.getElementById('game').appendChild(obEl);
    obstacles.push({element: obEl, x: 110});
  }

  function spawnBox() {
    const boxEl = document.createElement('div');
    boxEl.className = 'box';
    boxEl.style.left = '110vw';
    document.getElementById('game').appendChild(boxEl);
    boxes.push({element: boxEl, x: 110});
  }

  function checkCollisions() {
    const dinoRect = dino.getBoundingClientRect();

    // Check obstacle collisions
    for (const ob of obstacles) {
      const obRect = ob.element.getBoundingClientRect();
      if (rectOverlap(dinoRect, obRect)) {
        endGame();
        return;
      }
    }
    
    // Check box collisions
    for (let i = boxes.length - 1; i >= 0; i--) {
      const box = boxes[i];
      const boxRect = box.element.getBoundingClientRect();
      if (rectOverlap(dinoRect, boxRect)) {
        // Collect coin
        coins++;
        localStorage.setItem('pasu_coins', coins);
        coinCountEl.textContent = coins;
        if (sfxEnabled) {
          sfxCoin.currentTime = 0;
          sfxCoin.play().catch(e => console.log('SFX play error:', e));
        }
        box.element.remove();
        boxes.splice(i, 1);
      }
    }
  }

  function rectOverlap(r1, r2) {
    return !(r2.left > r1.right ||
             r2.right < r1.left ||
             r2.top > r1.bottom ||
             r2.bottom < r1.top);
  }

  // Character management
  function updateCharacterUI() {
    ownedCharactersEl.innerHTML = '';
    const characters = [
      {id: 'myDino', name: 'Default Dino', price: 0, img: 'myDino.png'},
      {id: 'peet', name: 'Peet', price: 30, img: 'peet.png'},
      {id: 'broin', name: 'Broin', price: 50, img: 'broin.png'}
    ];
    
    characters.forEach(char => {
      const hasChar = ownedCharacters.includes(char.id);
      const isSelected = selectedCharacter === char.id;
      const charDiv = document.createElement('div');
      charDiv.className = 'charItem';
      charDiv.innerHTML = `
        <img src="${char.img}" alt="${char.name}" />
        <button>${hasChar ? (isSelected ? 'Using' : 'Use') : `Buy (${char.price} coins)`}</button>
      `;
      const btn = charDiv.querySelector('button');
      btn.disabled = isSelected;
      btn.style.opacity = isSelected ? 0.6 : 1;
      btn.addEventListener('click', () => handleCharacterClick(char, hasChar, isSelected));
      ownedCharactersEl.appendChild(charDiv);
    });
  }

  function handleCharacterClick(char, hasChar, isSelected) {
    if (hasChar) {
      selectedCharacter = char.id;
      localStorage.setItem('pasu_selectedChar', selectedCharacter);
      updateSelectedCharacter();
      updateCharacterUI();
    } else {
      // Buy character
      if (coins >= char.price) {
        if (confirm(`Buy ${char.name} for ${char.price} coins?`)) {
          coins -= char.price;
          localStorage.setItem('pasu_coins', coins);
          ownedCharacters.push(char.id);
          localStorage.setItem('pasu_ownedChars', JSON.stringify(ownedCharacters));
          selectedCharacter = char.id;
          localStorage.setItem('pasu_selectedChar', selectedCharacter);
          coinCountEl.textContent = coins;
          updateCharacterUI();
          updateSelectedCharacter();
        }
      } else {
        alert('Not enough coins!');
      }
    }
  }

  function updateSelectedCharacter() {
    let charImg = 'myDino.png';
    if (selectedCharacter === 'peet') charImg = 'peet.png';
    else if (selectedCharacter === 'broin') charImg = 'broin.png';
    dino.style.backgroundImage = `url('${charImg}')`;
  }

  // Modal functions
  function openModal(modal) {
    modal.classList.add('active');
    modal.setAttribute('aria-hidden', 'false');
  }

  function closeModal(modal) {
    modal.classList.remove('active');
    modal.setAttribute('aria-hidden', 'true');
  }

  // Sound controls
  function toggleBGMSound(e) {
    bgmEnabled = e.target.checked;
    localStorage.setItem('pasu_bgm', bgmEnabled);
    if (bgmEnabled) {
      bgmAudio.play().catch(e => console.log('BGM play error:', e));
    } else {
      bgmAudio.pause();
    }
  }

  function toggleSFXSound(e) {
    sfxEnabled = e.target.checked;
    localStorage.setItem('pasu_sfx', sfxEnabled);
  }

  // Keyboard controls
  function handleKeyDown(e) {
    if (!isPlaying && e.code === 'Space') {
      startGame();
      return;
    }
    if (!isPlaying) return;
    if (e.code === 'Space' || e.code === 'ArrowUp' || e.code === 'KeyW') jump();
    else if (e.code === 'ArrowDown' || e.code === 'KeyS') slide();
  }

  // Visibility change handler
  function handleVisibilityChange() {
    if (document.hidden && bgmEnabled) {
      bgmAudio.pause();
    } else if (!document.hidden && bgmEnabled && isPlaying) {
      bgmAudio.play().catch(e => console.log('BGM play error:', e));
    }
  }

  // Initialize the game when page loads
  window.addEventListener('load', initGame);
})();
</script>
</body>
      </html>
